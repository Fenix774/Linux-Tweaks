Great ‚Äî I‚Äôll generate a **complete working routed network** for your VM *Windows 11*.

This network type:

‚úî works perfectly over Wi-Fi
‚úî gives VM ‚Üî host full communication
‚úî gives VM full Internet
‚úî does **not** require bridging or macvtap
‚úî works on every access point
‚úî no kernel/mac80211 limitations

This is exactly what you want when bridging on Wi-Fi fails.

---

# ‚úÖ STEP 1 ‚Äî Create a routed network definition

Run this and save it as **routed-net.xml**:

```xml
<network>
  <name>routed-net</name>
  <forward mode='route'/>
  <bridge name='virbr1' stp='off' delay='0'/>
  <ip address='192.168.200.1' netmask='255.255.255.0'>
    <dhcp>
      <range start='192.168.200.20' end='192.168.200.250'/>
    </dhcp>
  </ip>
</network>
```

This creates a virtual router with:

* Host IP: **192.168.200.1**
* VM DHCP range: **192.168.200.20 ‚Üí 250**
* Full routing to your Wi-Fi NIC
* NAT-less routing (so LAN devices may reach VM via host routing if added manually)

---

# ‚úÖ STEP 2 ‚Äî Define + start the network in libvirt

```bash
sudo virsh net-define routed-net.xml
sudo virsh net-start routed-net
sudo virsh net-autostart routed-net
```

Check:

```bash
sudo virsh net-list --all
```

You should see:

```
routed-net  active  yes
```

And a Linux bridge:

```bash
ip addr show virbr1
```

---

# ‚úÖ STEP 3 ‚Äî Attach **Windows 11** to the routed network

In virt-manager:

1. Open **Windows 11 ‚Üí Details ‚Üí NIC**
2. Change **Network source** to: `routed-net`
3. Device model: **virtio** (important for performance)
4. Apply

Or command-line:

```bash
sudo virsh detach-interface "Windows 11" --type network --current
sudo virsh attach-interface "Windows 11" --type network --source routed-net --model virtio --persistent
```

---

# üîÑ STEP 4 ‚Äî Restart the VM

Windows 11 will get an IP like:

```
192.168.200.20
gateway 192.168.200.1
dns 192.168.200.1
```

Check inside Windows:

```
ipconfig
```

You should now have:

‚úî Internet access
‚úî Host ‚Üî VM communication
‚úî VM isolated from LAN unless you add routes (optional)

---

# üõ† OPTIONAL: Allow LAN devices to reach the VM

If you want LAN PCs to reach the VM directly, I can generate the routes.
Just tell me:

* Your host‚Äôs Wi-Fi IP (e.g., 192.168.1.x)

---

# If you want, I can prepare:

* A routed network with IPv6
* Static DHCP for Windows 11
* Port forwarding (e.g. RDP from host ‚Üí VM)

Just tell me what you need!

















If the VM had internet for a few seconds **and then it stopped**, that tells me something very specific:

### ‚úîÔ∏è Your routing/NAT is correct

(because it *did* work)

### ‚ùå But the host firewall or NetworkManager keeps **overwriting** the rule after a few seconds

‚Äî OR ‚Äî
virbr1 is not being recognized as an allowed forwarding interface.

This happens **all the time** on Wi-Fi setups using routed networks.

Let's fix this properly and permanently.

---

# ‚úÖ STEP 1 ‚Äî Confirm which firewall you are using

Run this:

```bash
systemctl is-active firewalld && echo "firewalld" || echo "no-firewalld"
```

And:

```bash
sudo iptables -t nat -S
```

Whichever system is active must get a **persistent MASQUERADE rule**.

---

# üî• FIX FOR FIREWALLD (Fedora, RHEL, some Ubuntu)

Firewalld removes iptables rules after a few seconds, which explains your symptom.

Run:

```bash
sudo firewall-cmd --permanent --add-masquerade
sudo firewall-cmd --reload
```

Then **explicitly allow forwarding** from virbr1 to Wi-Fi:

Replace `wlp0s20f3` with your Wi-Fi iface:

```bash
sudo firewall-cmd --permanent --add-forward --zone=public
sudo firewall-cmd --permanent --direct --add-rule ipv4 nat POSTROUTING 0 -s 192.168.200.0/24 -o wlp0s20f3 -j MASQUERADE
sudo firewall-cmd --reload
```

This stops firewalld from deleting the NAT rule.

---

# üî∞ FIX FOR IPTABLES / NFTABLES (Ubuntu, Debian, Arch, Manjaro)

If you‚Äôre using iptables/nftables, add persistence:

```bash
sudo iptables -t nat -A POSTROUTING -s 192.168.200.0/24 -o wlp0s20f3 -j MASQUERADE
```

Save permanently:

**Debian/Ubuntu**

```bash
sudo apt install iptables-persistent
sudo netfilter-persistent save
```

**Arch**

```bash
sudo iptables-save | sudo tee /etc/iptables/iptables.rules
sudo systemctl enable iptables
```

Without persistence, NetworkManager or systemd restores a clean table after a few seconds ‚Üí your exact failure.

---

# üü¶ STEP 2 ‚Äî Allow forwarding through virbr1

Add this to `/etc/sysctl.d/99-ipforward.conf`:

```
net.ipv4.ip_forward = 1
net.ipv4.conf.all.forwarding = 1
net.ipv4.conf.virbr1.forwarding = 1
net.ipv4.conf.wlp0s20f3.forwarding = 1
```

Then:

```bash
sudo sysctl --system
```

---

# üü¶ STEP 3 ‚Äî Test again

1. Restart libvirt:

```bash
sudo systemctl restart libvirtd
```

2. Reboot the VM
3. Test inside the VM:

```
ping 192.168.200.1
ping 8.8.8.8
ping google.com
```

---

# üü© IMPORTANT QUESTION

I want to give you the *exact* commands for your system.

Please paste the outputs of:

```
systemctl is-active firewalld
```

```
sudo iptables -t nat -S
```

```
nmcli device | grep wifi -i
```

With that, I will produce a **one-line fix** that matches your OS and firewall.
